# Q. 넷플릭스 홈에서는 어떻게 딜레이 없이 수 백개의 영상들을 제공할 수 있을까?
>캐싱을 사용한다고 가정해도 홈에서 제공하는 수백개가 넘는 영상들을 전부 캐싱할 수는 없을 것<br>
그렇다면 넷플릭스는 어떻게 딜레이 없이 수백개의 영상을 제공하는 걸까?

---

# A. 넷플릭스와 같은 대규모 영상 스트리밍 서비스의 경우 단순 영상 캐싱과 함께 여러 레이어의 최적화가 합쳐져 사용자에게 서비스를 제공한다.

### 대규모 영상 스트리밍 서비스에서 제공하는 다양한 레이어<br>
## 최적화
> ### CDN
> 영상을 중앙 서버에서만 제공할 경우 레이턴시가 증가, **사용자와 가장 가까운 서버**에서 데이터 제공 <br>
> 본편 스트리밍은 넷플릭스 전용 CDN인 Open Connect 가 담당 <br>
> 사용자와 가까운 OCA까지 콘텐츠를 **야간 채움**으로 미리 분산시켜 두고, 재생 시점에는 클라이언트 특성과 네트워크 조건을 보고 가장 가까운/건강한 캐시로 바로 보냄 <br>
> 만약 대한민국 서버를 사용하는 사용자가 넷플릭스에 접속 시, 넷플릭스 본사가 있는 서버(미국)가 아닌 사용자와 가장 가까운 서버(대한민국)에 사용자가 자주 보는 데이터들을 미리 캐싱해놓고, 데이터를 제공하는 방식 <br>

**야간 채움**: 사용자가 영상을 요청하기도 전에, 미리 OCA(엣지 캐시 서버)에 콘텐츠를 채워 넣는 작업
- **장점**
  - **지연 최소화**: 사용자가 요청했을 때 이미 가까운 OCA에 있으므로 즉시 시작 가능
  - **네트워크 비용 절감**: 국제망/백본망을 통한 실시간 대규모 전송을 피함
  - **대규모 트래픽 분산**: 피크 타임 저녁 네트워크 혼잡 완화
  - **서비스 안정성**: 갑자기 특정 콘텐츠가 폭발적 인기를 끌어도 이미 캐시되어 있음

> ### 비디오 스트리밍 방식 (HLS/DASH)
> 영상을 하나의 큰 파일로 전송하는 것이 아닌, 수 초 단위의 **작은 청크 단위로 나누어 전송** <br>
> 사용자가 재생을 시작하게 되면 초반 청크 일부만 다운로드 받아 바로 스트리밍을 시작 <br>
> 나머지 청크들에 대해서는 백그라운드에서 지속적으로 다운로드 및 버퍼링을 적용해 끊임없는 스트리밍 제공 <br>
> 1시간짜리 영화가 있다면 한 번에 1시간짜리 전체 데이터를 전송하는게 아닌, 5초 단위로 쪼개어 데이터를 전송하고, 플랫폼에서는 사용자가 영상을 시청하는 동안 백그라운드에서 나머지 청크들을 지속적으로 다운로드하는 방식

> ### ABR (Adaptive Bitrate Streaming)
> 사용자의 네트워크 속도에 맞추어 화질을 조정하는 기술 적용 <br>
> ABR을 통해 사용자에게 끊기지 않는 스트리밍 서비스를 제공할 수 있음 <br>
> 유튜브를 시청할 때 네트워크 환경이 좋지 않으면 360p로 화질을 낮추어 영상을 재생하다가 환경이 좋아지면 다시 720p 등으로 올리는 방식  

> ### 메타데이터 및 썸네일 로딩
> 홈 화면의 각 타일은 제목/설명/등급 같은 메타데이터와, 여러 비율(16:9, 2:3 등)로 미리 만들어 둔 아트워크 이미지만 제공 <br>
> 이 이미지들은 차세대 포맷(AVIF, WebP)으로 제공되어, 품질을 유지하면서 용량을 크게 줄이는 게 가능해짐<br>
> 따라서 홈에서 보여지는 정보들은 영상 스트리밍이 아닌 이미지 + 데이터 정보 <br>
> 즉, 사용자가 실제 영상 화면에 접근하기 전까지 영상 데이터를 로딩하지 않고 메타데이터 및 썸네일만 로딩 -> 질문의 해답!

## 실제 서비스 제공 프로세스
### 0. 앱 / 웹 진입
> **DNS & 라우팅**
> 클라이언트는 홈을 구성하기 위해 여러 도메인으로 요청 <br>
> 지리적으로 가장 가까운 엣지(Edge) 로 연결되도록 Anycast + GeoDNS 조합을 활용 <br>
> ISP 내에 설치된 OCA와 같은 엣지 캐시가 후보로 선택

**OCA (Open Connect Appliance)** : 넷플릭스가 자체적으로 개발한 CDN 서비스로 ISP의 통신망에 설치되어 콘텐츠를 미리 저장하고 스트리밍 시 사용자와 가장 가까이에서 고화질 콘텐츠를 빠르게 전송

> **TLS 세션 수립 및 재사용**
> TLS 1.3 기반으로 핸드셰이크 진행 → 세션 키 협상 <br>
> 전송은 HTTP/2 또는 HTTP/3(QUIC) 로 수행

**HTTP/2** : 단일 TCP 연결에서의 멀티플렉싱과 헤더 압축, 스트림 우선순위로 동시성↑ <br>
**HTTP/3(QUIC)** : UDP 기반 멀티플렉싱으로 TCP HOL 문제 완화, 0-RTT 재개, 개선된 혼잡제어 <br>
**TCP HOL 문제** : 포워딩 시 앞에 존재하는 패킷으로 인해 뒤에 존재하는 바로 처리 가능한 패킷이 딜레이되는 것


> **메타 데이터 요청**
> 사용자 / 프로필 / 시청 이력에 따른 개인화 결과가 반영된 가벼운 JSON 응답

> **썸네일, 아트워크 로딩 (지연 로딩)** <br>
> 홈 화면에서 보여줄 전체 데이터를 한 번에 로딩 X <br>
> 사용자의 홈 화면에서 보이는 데이터 위주로 데이터 요청 <br>
> 사용자가 스크롤 시 추가적으로 데이터 요청


### 1. 재생 버튼 클릭
> **재생 세션 / 권한 토큰 발급** <br>
> 클라이언트는 프로필 ID, 콘텐츠(타이틀) ID, 디바이스/플랫폼 정보, DRM 능력 등을 담아 재생 허가 API를 호출 <br>
> 서버는 응답으로 다음 정보를 반환
> - Manifest URL (HLS / DASH)
> - DRM 라이선스 서버 URL(Widevine / PlayReady / FairPlay)
> - 다중 CDN/다중 BaseURL 후보(엣지 장애 시 페일오버)
> - 재생 정책

**[HLS (HTTP Live Streaming)](https://edgeone.ai/ko/learning/hls-vs-dash)** : HTTP 기반의 적응형 비트 전송률 스트리밍 미디어 전송 프로토콜<br>
**[DASH](https://edgeone.ai/ko/learning/hls-vs-dash)** : HTTP 기반의 적응형 비트 전송률 스트리밍 미디어 전송 프로토콜

> **DRM 준비** <br>
> 플레이어는 CDM과 상호작용해 라이선스 키 요청을 생성 <br>
> DRM 라이선스 서버에 요청을 보내 콘텐츠 키를 받아옴 <br>
> 보통 Manifest 요청과 병렬로 수행하여 초기 지연을 최소화

**DRM** : 디지털 콘텐츠의 저작권을 보호하기 위해 의도한 용도로만 사용되도록 제한하는 모든 기술 (화면 녹화 방지 ..) <br>
**CDM (Content Decryption Module)** : DRM에서 복호화 기능을 담당하는 모듈

> **Manifest (플레이리스트) 다운로드** <br>
> HLS 또는 DASH 문서 <br>
> 시간축을 분할한 세그먼트 목록, 다중 비트레이트, 디오/자막 트랙, 다중 오디오 언어, CMAF(fMP4) 호환 여부 등을 파악

> **초기 ABR 선택** <br>
> 초기 RTT/대역폭 추정, 최근 세션 이력, 디바이스 성능을 바탕으로 보수적인 비트레이트부터 선택 <br>
> 빠른 시작을 위해 초기 몇 개 세그먼트만 먼저 요청

**RTT (Round-Trip Time)** : 클라이언트 ↔ 서버 간 왕복 지연 시간

> **초기 세그먼트 요청 & 버퍼링**<br>
> MP4, FMP4 초기 세그먼트 요청<br>
> 버퍼 임계치(1~3초) 가 차면 즉시 화면/오디오 출력 시작 → 체감 지연 최소화<br>
> 이후 다운로드 ↔ 디코딩 ↔ 재생 프로세스를 안정 상태로 유지

> **자막 / 오디오 트랙 병렬 요청**<br>
> TTML / IMSC 등 요청하며, 별도 트랙인 경우 설계 필요

**TTML** : XML 기반 자막 표준
**IMSC** : TTML의 프로필/서브셋 표준으로 브로드캐스트·OTT 호환성에 초점

### 2. 재생 중
> **지속적인 ABR 스위칭** <br>
> 플레이어는 실시간 네트워크 상태를 추적<br>
> - 세그먼트 다운로드 시간
> - 최근 처리량
> - 프레임 드랍 여부
> - RTT, 패킷 손실률 등<br>
> 
> 네트워크 여유가 충분하면 상위 화질로 **업스위치** <br>
> 네트워크 혼잡 / 패킷 손실 발생 시 **다운스위치**

> **프리패치 / 버퍼 관리** <br>
> 일반적으로 10~30초 분량의 버퍼 유지 <br>
> 세그먼트 다운로드 성공 시 다음 세그먼트 선 요청 (프리패치) <br>
> 버퍼 목표치에 따라 다중 스레드 다운로드 조정 → 화면 끊김 최소화 <br>
> 네트워크 변화에 따라 버퍼를 늘리거나 줄이는 동적 조정 가능

> **CDN 장애 / 성능 저하 시 페일오버** <br>
> 세그먼트 요청 타임아웃, 500 에러, 지속적인 저속 상태 감지 시 <br>
> - Manifest의 대체 BaseURL로 즉시 전환
> - 필요 시 다른 POP나 다른 CDN으로 재시도 <br>
> 
> 페일오버 시 초기 버퍼링 유지하며 화질 하락 최소화 전략 적용

**페일오버** : 서버, 시스템, 네트워크 등 실 운용환경에서 이상이 생겼을 때 대체 작동 또는 장애 조치

### 3. 에피소드 자동 다음 재생 & 프리페치
> **사용자의 완주율 및 시청 습관 분석**<br>
> 다음 에피소드의 초기 세그먼트를 미리 다운로드하여 재생 지연 최소화<br>
> 자동재생 타이머 종료 시
> - 라이선스 재검증 수행
> - Manifest 요청
> - 초기 세그먼트 요청

